<!DOCTYPE html>
  <html>
  <head>
    <meta charset=utf-8 />
    <title>WMS is dead, long live WASM</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!-- Load Leaflet from CDN-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet-src.js"></script>

    <!-- load esri leaflet and its geocoder for address/place search -->
    <script src="https://unpkg.com/esri-leaflet@2.1.3/dist/esri-leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/esri-leaflet-geocoder@2.2.8/dist/esri-leaflet-geocoder.css">
    <script src="https://unpkg.com/esri-leaflet-geocoder@2.2.8/dist/esri-leaflet-geocoder.js"></script>

    <!-- slider library-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.2.1/nouislider.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/8.2.1/nouislider.min.js"></script>

    <!-- load our plugin -->
    <script src="qb3dec.js"></script>

    <script>
        var QB3dec = Module;
        QB3dec.onRuntimeInitialized = () => {
            // char * GetInfo(void *data, size_t sz);
            // important fields are
            // xsize, ysize, nbands, and type
            // type is one of <u>int[8|16|32|64]

            QB3dec.GetInfo = this.cwrap('GetInfo', 'number', ['number', 'number']);
            // size_t decode(void *data, size_t sz, double *out, char *message);
            QB3dec.decode = this.cwrap('decode', 'number', ['number', 'number', 'number', 'number']);

            // Attach the higher level functions
            QB3dec.getInfo = function(data) {
                // Use a small array, to avoid the full size
                if (data.length > 1000)
                    data = data.slice(0, 1000);
                var dataPtr = this._malloc(data.length);
                this.writeArrayToMemory(data, dataPtr);
                let cresult = this.GetInfo(dataPtr, data.length);
                // This is actually a json string
                if (cresult == 0)
                    return null;
                let response = this.UTF8ToString(cresult);
                this._free(dataPtr);
                this._free(dataPtr);
                return JSON.parse(response);
            }

            QB3dec.decodeData = function(data) {
                let image = this.getInfo(data);
                if (!image) {
                    console.error("Failed to get QB3 raster");
                    return null;
                }
                // Print the image info to console
                console.log("Image Info:", image);

                // Copy the data to wasm
                rawqb3 = this._malloc(data.length);
                this.writeArrayToMemory(data, rawqb3);

                if (image.type != "uint16") {
                    console.error("Unsupported data type: " + image.type);
                    this._free(rawqb3);
                    return null;
                }
                // Image size in bytes
                let imageSize = image.xsize * image.ysize * image.nbands * 2;
                // Allocate the output buffer
                let outPtr = this._malloc(imageSize);
                // Allocate a buffer for the message
                let message = this._malloc(1024);
                decoded = this.decode(rawqb3, data.length, outPtr, message);
                // Free the raw data buffer
                this._free(rawqb3);
                if (decoded == 0) {
                    this._free(outPtr);
                    console.error("Decoding failed: " + this.UTF8ToString(message));
                    this._free(message);
                    return null;
                }
                this._free(message);

                // View, no need to free. Pixel interleaved
                image.data = new Uint16Array(this.HEAPU8.buffer, 
                    outPtr, image.xsize * image.ysize * image.nbands);
                image.outPtr = outPtr;
                image.clean = function() {
                    QB3dec._free(this.outPtr);
                }
                return image;
        }

    </script>

    <style>
      body {
        margin:0;
        padding:0;
      }

      #map {
        position: absolute;
        top:0;
        bottom:0;
        right:0;left:0;
      }

      #info-pane {
        position: absolute;
        top: 10px;
        right: 10px;
        min-width: 200px;
        z-index: 500;
        padding: 1em;
        background: white;
      }

      .noUi-connect {
        background: #ccc;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <div id="info-pane">
      <h2>QB3 prototype</h2>
    </div>

    <script>
        let southWest = L.letLng(-90, -179);
        let northEast = L.latLng(90, 179);
        let bounds = L.latLngBounds(southWest, northEast);

        // Create the map
        var map = L.map('map', {
            noWrap: true,
            center: [0, 0],
            zoom: 2,
            zoomControl: true,
            maxBounds: bounds,
            attributionControl: true
        });
    
        // Add a base layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    
        // Add a marker for testing
        var marker = L.marker([0, 0]).addTo(map);
        marker.bindPopup('QB3 prototype').openPopup();
    </script>
  </body>
  </html>