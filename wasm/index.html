<!DOCTYPE html>
  <html>
  <head>
    <meta charset=utf-8 />
    <title>QB3 decoder protytype</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!-- Load Leaflet from CDN-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet-src.js"></script>

    <!-- load our plugin -->
    <script src="qb3dec.js"></script>

    <script>
        var QB3dec = Module;
        QB3dec.onRuntimeInitialized = () => {

            // char * GetInfo(void *data, size_t sz);
            // important fields are
            // xsize, ysize, nbands, and type
            // type is one of <u>int[8|16|32|64]
            QB3dec.GetInfo = this.cwrap('GetInfo', 'number', ['number', 'number']);

            // size_t decode(void *data, size_t sz, double *out, char *message);
            QB3dec.decode = this.cwrap('decode', 'number', ['number', 'number', 'number', 'number']);

            // Attach the higher level functions
            QB3dec.getInfo = function(data) {
                // Use a small array, to avoid the full size
                if (data.length > 1000)
                    data = data.slice(0, 1000);
                var dataPtr = this._malloc(data.length);
                this.writeArrayToMemory(data, dataPtr);
                let cresult = this.GetInfo(dataPtr, data.length);
                // This is actually a json string
                if (cresult == 0)
                    return null;
                let response = this.UTF8ToString(cresult);
                this._free(dataPtr);
                return JSON.parse(response);
            }

            QB3dec.decodeData = function(data) {
                let image = QB3dec.getInfo(data);
                if (!image) {
                    console.error("Failed to get QB3 raster");
                    return null;
                }
                // Print the image info to console
                console.log("Image Info:", image);

                // Copy the data to wasm
                rawqb3 = this._malloc(data.length);
                this.writeArrayToMemory(data, rawqb3);

                if (image.dtype != "uint16") {
                    console.error("Unsupported data type: " + image.type);
                    this._free(rawqb3);
                    return null;
                }
                // Image size in bytes
                let imageSize = image.xsize * image.ysize * image.nbands * 2;
                // Allocate the output buffer
                let outPtr = this._malloc(imageSize);
                // Allocate a buffer for the message
                let message = this._malloc(1024);
                decoded = this.decode(rawqb3, data.length, outPtr, message);
                // Free the raw data buffer
                this._free(rawqb3);
                if (decoded == 0) {
                    this._free(outPtr);
                    console.error("Decoding failed: " + this.UTF8ToString(message));
                    this._free(message);
                    return null;
                }
                this._free(message);

                // View, no need to free. Pixel interleaved
                image.data = new Uint16Array(this.HEAPU8.buffer, 
                    outPtr, image.xsize * image.ysize * image.nbands);
                image.outPtr = outPtr;
                image.clean = function() {
                    QB3dec._free(this.outPtr);
                }
                return image;
        }

        QB3_012.addTo(map);
    }
    </script>

    <script>
        var QB3Layer = L.GridLayer.extend({
            createTile: function(coords, done) {
                var error;
                var tile = L.DomUtil.create('canvas', 'leaflet-tile');
                tile.width = this.options.tileSize;
                tile.height = this.options.tileSize;
                tile.zoom = coords.z;

                var xhr = new XMLHttpRequest();
                xhr.responseType = 'arraybuffer';

                var url = 'tile' + '/' + coords.z + '/' + coords.x + '/' + coords.y;
                xhr.open("Get", url, true);
                xhr.send();
                
                xhr.onreadystatechange = function (evt) {
                    if (evt.target.readyState == 4 && evt.target.status == 200) {
                        var data = new Uint8Array(evt.target.response);
                        tile.image = QB3dec.decodeData(data);
                        if (tile.image)
                          this.draw(tile);
                        else {
                            erro = "Unrecognized QB3 data";
                        }
                        done(error, tile);                        
                    }
                }.bind(this);

                return tile;
            },

            draw: function(tile) {
                let width = tile.width;
                let height = tile.height;
                let nbands = tile.image.nbands;
                let values = tile.image.data;

                // Verify that the image data has the expected size
                if (values.length !== width * height * nbands) {
                    console.error("Image data size mismatch: expected " + (width * height * nbands) + ", got " + values.length);
                    return;
                }

                // This needs to convert the values to 8 bit and draw them
                let ctx = tile.getContext('2d');
                let imageData = ctx.createImageData(width, height);
                // Convert bands 0,1,2 to RGB
                for (let i = 0; i < width * height; i++) {
                    let r = values[i * nbands] >> 8; // Red band
                    let g = values[i * nbands + 1] >> 8; // Green band
                    let b = values[i * nbands + 2] >> 8; // Blue band
                    imageData.data[i * 4] = r;
                    imageData.data[i * 4 + 1] = g;
                    imageData.data[i * 4 + 2] = b;
                    imageData.data[i * 4 + 3] = 255; // Alpha
                }

                ctx.putImageData(imageData, 0, 0);
            }
        })
    </script>

    <style>
      body {
        margin:0;
        padding:0;
      }

      #map {
        position: absolute;
        top:0;
        bottom:0;
        right:0;left:0;
      }

      #info-pane {
        position: absolute;
        top: 10px;
        right: 10px;
        min-width: 200px;
        z-index: 500;
        padding: 1em;
        background: white;
      }

      .noUi-connect {
        background: #ccc;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <div id="info-pane">
      <h2>QB3 prototype</h2>
    </div>

    <script>
        let southWest = L.latLng(-90, -179);
        let northEast = L.latLng(90, 179);
        let bounds = L.latLngBounds(southWest, northEast);

        // Create the map
        var map = L.map('map', {
            noWrap: true,
            center: [0, 0],
            zoom: 2,
            zoomControl: true,
            maxBounds: bounds,
            attributionControl: true
        });
    
      
        let QB3_012 = new QB3Layer({
            tileSize: 512,
            attribution: 'QB3 prototype'
        });
    
        // Add a marker for testing
        var marker = L.marker([0, 0]).addTo(map);
        marker.bindPopup('QB3 prototype').openPopup();
    </script>
  </body>
  </html>